# 쿠버네티스 입문

## 쿠버네티스란
컨테이너 운영을 자동화 하기 위한 커넽이너 오케스트레이션 도구.<br/>
많은 수의 컨테이너를 협조적으로 연동시키기 위한 통합 시스템으로, API 및 명령행 도구등이 함께 제공된다.

애플리케이션 배포 이외에도 다양한 운영 관리 업무를 자동화 할 수 있다.
- 도커 호스트 관리
- 서비스 리소스의 여유를 고려한 컨테이너 배치 및 스케일링
- 여러개 컨테이너 그룹에 대한 로드밸런싱 Health Check

## Kubectl
쿠버네티스를 다루기 위한 명령행 도구

kubernetes-dashboard를 이용하면 쿠버네티스에 관한 정보들을 쉽게 확인할 수 있다.

## MiniKube
Docker에 Kubernetes 연동 기능이 추가되기전까지 사용되던 minikube는 로컬에 dockerd를 새로 띄워 이를 대상으로 쿠버네티스 환경을 구축하였다.<br/>

dockerd가 2개이므로 다루기에 상대적으로 까다로운 단점이 있으나, 지원 플랫폼이 다양한 장점이 있다.(Win10 Pro 이하에서는 hyper-v 지원이 되지 않아 minikube를 사용할 수 밖에 없다.)

## 쿠버네티스 클러스터

여러 리소스를 관리하기 위한 집합체.

마스터와 노드의 그룹으로 구성되며,<br/>
쿠버네티스 클러스터 전체를 관리하는 서버인 마스터가 적어도 하나 이상 있어야한다.

클러스터에 배치된 노드의 수, 노드의 사양 등에 따라 배치할 수 있는 컨테이너의 수가 결정된다.

클라우드 플랫폼 상에서 GCP는 GCE가 AWS는 EC2 인스턴스가 노드가 된다.

## 마스터 서버의 컴포넌트
1. **kube-apiserver** : API를 노출. kubectl로부터 리소스를 조작하라는 지시를 받는다.
2. **etcd** : 고가용성 k-v 분산스토어로, 클러스터 백킹 스토어로 쓰인다.
3. **kube-scheduler** : 노드를 모니터링하고, 컨테이너 배치에 적절한 노드를 선택한다.
4. **kube-controller-manager** : 리소스를 제어하는 컨트롤러를 실행한다.

non-managed 환경에서 마스터 서버가 SPOF(Single Point Faliure: 단일 장애점. 시스템 구성 요소중 동작하지 않으면 전체 시스템이 중단되는 요소)가 되지 않도록 마스터를 3대 두는것이 일반적이다.

---

## 용어 정리
### Namespace
클러스터 안의 가상 클러스터

### Pod
컨테이너 하나 혹은 컨테이너의 집합체

nginx 컨테이너와 JAVA 애플리케이션 컨테이너와 같이 서로 강한 결합을 유지하는 경우 또는 함께 배포해야 정합성을 유지할 수 있는 컨테이너 등은 같은 Pod로 묶어 일괄 배포한다.<br/>
하나인 경우에도 Pod로 배포한다.

Pod는 노드에 배치되며 같은 Pod를 여러 노드에 둘수도 있고, 한 노드에 여러개의 Pod를 둘 수도 있다.

한 Pod안의 컨테이너는 모두 같은 노드에 배치해야한다.

마스터 노드에는 관리용 컴포넌트만 담긴 Pod가 배포되므로, 애플리케이션 파드를 배포할 수 없다.

### Manifest File
쿠버네티스 리소스 정의 파일.

배포시에 manifest 파일의 내용을 그대로 반영하려면 apply 명령을 사용할 때 `-f` 옵션으로 경로를 지정하면 된다.<br/>
ex)
```shell script
$ kubectl apply -f ./simple-pod.yaml
```

#### Kind
쿠버네티스 리소스 유형을 지정하는 속성.<br/>
값에 따라 Spec 아래의 스키마가 변화한다.

#### metadata
리소스에 부여되는 메타데이터

#### spec
리소스를 정의하기 위한 속성. 파드의 경우 파드를 구성하는 컨테이너를 `containers` 아래에 정의한다.

#### ports
컨테이너가 Expose 할 포트를 지정할 수 있으나, Dockerfile에서 지정했을 경우 따로 지정할 필요가 없다.

---

## 명령어 정리

- 현재 클러스터에 소속된 노드의 목록 : `$ kubectl get nodes`
- 현재 클러스터 안에 존재하는 네임스페이스의 목록 조회 : `$ kubectl get namespace`
- **$ kubectl apply -f {manifest 파일 경로}** : 파일의 경로를 지정하여 `manifest`의 내용을 반영
- **$ kubectl get pod** : 파드정보를 조회. READY 필드는 {실행상태_컨테이너개수}/{파드에_정의된_컨테이너개수}
- **$ kubectl exec -it {파드명} sh -c {컨테이너명}** :  `docker container exec` 명령과 유사하나, 파드안의 컨테이너가 여러개인 경우 -c 옵션에 컨테이너 명을 지정한다.
- **$ kubectl logs** : stdout 로그 조회 (`docker container logs` 명령과 같다)
- **$ kubectl delete pod {파드명}** : 지정된 파드 삭제
- **$ kubectl delete -f {manifest 파일 경로}** : manifest 안에 작성된 리소스 전체가 삭제된다.