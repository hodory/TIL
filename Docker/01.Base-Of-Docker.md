# 도커의 기초

도커는 컨테이너형 가상화 기술(운영체제 수준 가상화)를 사용한다.

이전에는 LXC(Linux Containers)가 유명했는데, 도커도 초기에는 LXC를 런타임으로 사용(현재는 runC를 사용)했다.

---

Dockerfile이나 애플리케이션 실행 파일을 사용해서 도커 컨테이너의 원형이 될 이미지를 만드는 과정을 `도커 이미지 빌드`라고 한다.

## Dockerfile

도커가 어떻게 이미지를 만들고 실행할지가 여기에 정의된다.

### 도커 빌드 과정에서 쓰이는 명령어(빌드시에만 사용되고 캐시됨)

---

### From

컨테이너의 원형(틀) 역할을 할 도커 이미지(운영 체제)를 정의한다.

### COPY

파일을 복사하는데 사용

### RUN

도커 컨테이너 안에서 어떤 명령을 수행하기 위한것.

### 컨테이너 실행전 실행할 명령어

---

### CMD

이미지를 도커 컨테이너로 실행하기 전에 먼저 실행할 명령

## 도커이미지 빌드
```
    $ docker image build -t {IMAGE_NAME}:{TAG}
```
### 도커 이미지 실행
```
    $ docker container run {IMAGE_NAME}:{TAG}
```
## [LinuxKit](https://github.com/linuxkit/linuxkit)

---

윈도우/맥용 Docker는 LinuxKit을 경량 서브시스템으로 사용해 도커를 실행한다.

리눅스 서브 시스템을 제공하여 그 위에서 도커가 동작하도록 하는 형태로 VirtualBox를 경유하여 dockerd를 실행하던 기존의 방식을 해결하여, 오버헤드를 감소시킨다.

현재 도커 사가 주도로해서 리눅스 재단, MS, Intel, ARM, IBM 등과 함께 개발중이다.

## 도커를 사용하는 의의

---

### 환경 차이로 인한 문제 방지

1. 애플리케이션은 뭔가에 의존성을 갖게 되므로, 의존하는 환경의 차이를 가능한 한 배제하는것이 좋다.
2. 코드로 관리하는 인프라(Infrastructure as Code)와 불변 인프라(Immutable Infrastructure)
    1. 코드 기반으로 관리하는 인프라가 만병 통치약은 아니다.
    stable 버전이 변경될 수 있는 등의 항상 같은 결과가 보장되지 않기 때문에 멱등성을 확보할 수 있도록해야한다.
    → 어떤 시점의 서버상태를 저장해 복제할 수 있게 하자는 개념(서버 이미지 또는 스냅샷)으로 불변 인프라를 사용
    2. 도커를 활용하면 이 개념을 간단하고 낮은 비용으로 실현할 수 있다.
        1. 운영체제 대부분을 호스트 운영체제와 공유하기 때문에 실행에 걸리는 시간이 적어져 수정하지 않고 인프라를 완전히 새로 만드는 불변 인프라와 궁합이 잘 맞음
        2. Dockerfile로 서버 구성을 코드로 관리할 수 있기때문에, 기존 컨테이너를 빠르게 폐기하고 새로이 구축 할 수 있어 코드로 관리하는 인프라와 개념이 맞다
3. 애플리케이션과 인프라 묶어 구축하기

### 애플리케이션 구성 관리의 용이성

---

도커를 이용하여 복잡한 시스템을 한 덩어리로 동작 시키는 것은 쉽지 않다.<br/>
각 컨테이너의 의존 관계나 실행 순서가 어긋나면 제대로 동작하지 않는 등의 문제가 생기기 때문이다.


#### 도커 컨테이너 오케스트레이션 시스템
여러 서버에 걸쳐 있는 여러 컨테이너를 관리하는 기법.

1. Docker Compose <br/>
여러 컨테이너를 사용하는 애플리케이션을 쉽게 관리할 수 있도록 도커 컴포즈(Docker Compose)라는 도구를 제공하고, YAML 포맷으로 작성된 설정 파일로 컨테이너를 정의하거나 컨테이너 간의 의존 관계를 정의해 시작 순서를 제어할 수 있다.

2. DockerSwarm <br/>
Docker Compose가 단일 서버를 넘어 여러 서버에 걸쳐 있는 여러 컨테이너를 관리할 수 있도록 한 도구.<br/>
컨테이너 증가/감소와 노드의 리소스를 효율적으로 활용하기 위한 컨테이너 배치 및 로드 밸런싱 기능 등을 갖추고 있다.<br/>
배포 시에도 롤링 업데이트가 가능해 운영 면에서도 장점이 많다.

3. Kubernetes <br/>
DockerSwarm 보다 기능이 충실하며 확장성이 높은 구글이 만든 오픈 소스 소프트웨어로 컨테이너 오케스트레이션 분야에서 사실상 표준으로 자리 잡고 있다.<br/>
허나 이는 복잡성이 높다고도 볼 수 있다.


### 운영 환경에서 빛을 발하는 도커

---

일반적으로 도커를 운영 환경에서 사용하는것을 `도커의 신뢰성`, `성능 면에서의 우려`, `현실적 운영 가능 여부`등의 이유로 사용하지 않는다고 한다.<br/>
이는 이전에 내가 다니던 회사들도 그랬고, 나도 타당한 답변을 하지 못했다.

1. `도커의 신뢰성` -> 이미 전세계적으로 많은 운영 환경에 도입되었고, 성숙한 커뮤니티를 가지고 있으며, 신뢰성도 인정 받고 있다.  
2. `성능 면에서의 우려` -> 성능면에서 스케일 아웃이 쉽다는 장점이 있음에도 오버헤드는 매우 적다.
3. `현실적 운영 가능 여부`
-> 중소규모에서 컨테이너 이용이 확산되면서 적절한 서비스 이용을 생각하면 운영에 어렵지 않은 단계에 도달했다.

구글 쿠버네티스 엔진(GKE), 엘라스틱 컨테이너 서비스(ECS), 애저 컨테이너 서비스 등의 매니지드 서비스와 같이 주요 클라우드 플랫폼에 컨테이너 운영 환경이 잘 갖추어져 있어,<br/>
이와 같이 운영 환경에 적용하기 위한 장벽은 많이 낮아졌다.

허나, 도커는 만능키가 아니기 때문에 적당한곳에 사용해야한다.

### 새로운 개발 스타일

도커가 인프라와 애플리케이션이 모두 컨테이너 형태로 코드 수준으로 관리 되기때문에, 이전에 비해 애플리케이션의 개발에 더 집중할 수 있게 되었다.
이로인해 기존에는 명확했던 인프라 엔지니어와 서버사이드 엔지니어의 영역 구분이 점점 희미해지고있다.

마이크로서비스 아키텍쳐가 등장하면서 도커를 이용한 개발에도 유리한 점이 있어 지지를 받고 있다.

외부 API 사용도 도커가 제공하는 목업 서버 개발 환경을 사용하는 경우가 늘고 있다.

## Linux에 도커 설치하기

Docker CE는 `apt-transport-https`, `ca-certificates`, `curl`, `software-properties-common` 패키지에 의존하게 된다.
